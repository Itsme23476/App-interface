name: Build Windows Installer

on:
  release:
    types: [created]
  workflow_dispatch:  # Allow manual trigger

# Required permissions for uploading to releases
permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r ai_file_organizer/requirements.txt
          
          # Verify PySide6 is installed correctly
          python -c "import PySide6; print(f'PySide6 version: {PySide6.__version__}')"
          python -c "from PySide6.QtWidgets import QApplication; print('QtWidgets OK')"
          python -c "from PySide6.QtCore import QCoreApplication; print('QtCore OK')"
      
      - name: Build with PyInstaller
        run: |
          cd ai_file_organizer
          
          # Build with proper PySide6 collection
          # --collect-all PySide6: Collects all Qt modules, plugins, and data
          # --collect-all shiboken6: Collects the PySide6 bindings layer
          # --hidden-import: Explicitly include modules that might not be detected
          
          $baseArgs = @(
            "--name", "AIFileOrganizer",
            "--windowed",
            "--onefile",
            "--collect-all", "PySide6",
            "--collect-all", "shiboken6",
            "--collect-all", "spellchecker",
            "--collect-data", "spellchecker",
            "--add-data", "app/ui/styles.qss;app/ui",
            "--add-data", "app/ui/styles_light.qss;app/ui",
            "--hidden-import", "PySide6.QtCore",
            "--hidden-import", "PySide6.QtGui",
            "--hidden-import", "PySide6.QtWidgets",
            "--hidden-import", "PySide6.QtNetwork",
            "--hidden-import", "PySide6.QtSvg",
            "--hidden-import", "PySide6.QtSvgWidgets",
            "--hidden-import", "PIL",
            "--hidden-import", "PIL.Image",
            "--hidden-import", "requests",
            "--hidden-import", "openai",
            "--hidden-import", "json5",
            "--hidden-import", "spellchecker",
            "--noconfirm"
          )
          
          if (Test-Path "assets/icon.ico") {
            echo "Building with icon..."
            $baseArgs += @("--icon", "assets/icon.ico", "--add-data", "assets;assets")
          } else {
            echo "Building without icon..."
          }
          
          # Add the main script
          $baseArgs += "main.py"
          
          echo "Running PyInstaller with args: $baseArgs"
          pyinstaller @baseArgs
          
          echo "=== Build complete ==="
          echo "Checking output size..."
          $exePath = "dist\AIFileOrganizer.exe"
          if (Test-Path $exePath) {
            $size = (Get-Item $exePath).Length / 1MB
            echo "EXE size: $([math]::Round($size, 2)) MB"
            if ($size -lt 50) {
              echo "WARNING: EXE seems too small! Expected 80-150 MB for PySide6 app"
            }
          }
          dir dist
        shell: pwsh
      
      - name: Verify build output
        run: |
          if (Test-Path "ai_file_organizer/dist/AIFileOrganizer.exe") {
            echo "Build successful!"
          } else {
            echo "ERROR: EXE not found!"
            Get-ChildItem -Recurse ai_file_organizer | Select-Object FullName
            exit 1
          }
        shell: pwsh
      
      - name: Create Inno Setup installer script
        run: |
          $version = "${{ github.ref_name }}"
          if ([string]::IsNullOrEmpty($version) -or $version -eq "refs/heads/main") { 
            $version = "1.0.0" 
          }
          # Remove 'V' or 'v' prefix if present
          $version = $version -replace '^[Vv]', ''
          
          @"
          [Setup]
          AppName=AI File Organizer
          AppVersion=$version
          DefaultDirName={autopf}\AI File Organizer
          DefaultGroupName=AI File Organizer
          OutputDir=installer
          OutputBaseFilename=AI-File-Organizer-Setup
          Compression=lzma
          SolidCompression=yes
          PrivilegesRequired=admin
          
          [Files]
          Source: "ai_file_organizer\dist\AIFileOrganizer.exe"; DestDir: "{app}"; DestName: "AI File Organizer.exe"; Flags: ignoreversion
          
          [Icons]
          Name: "{group}\AI File Organizer"; Filename: "{app}\AI File Organizer.exe"
          Name: "{commondesktop}\AI File Organizer"; Filename: "{app}\AI File Organizer.exe"
          
          [Run]
          Filename: "{app}\AI File Organizer.exe"; Description: "Launch AI File Organizer"; Flags: nowait postinstall skipifsilent
          "@ | Out-File -FilePath installer.iss -Encoding utf8
        shell: pwsh
      
      - name: Install Inno Setup
        run: choco install innosetup -y
        shell: cmd
      
      - name: Build Installer
        run: |
          mkdir installer
          "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
        shell: cmd
      
      - name: Upload installer as artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: installer/*.exe
          if-no-files-found: error
      
      - name: Upload standalone exe as artifact
        uses: actions/upload-artifact@v4
        with:
          name: standalone-exe
          path: ai_file_organizer/dist/*.exe
          if-no-files-found: error
      
      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            installer/*.exe
            ai_file_organizer/dist/*.exe
          fail_on_unmatched_files: true
