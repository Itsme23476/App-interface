name: Build Windows Installer

on:
  release:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Update version from release tag
        if: github.event_name == 'release'
        run: |
          $version = "${{ github.ref_name }}" -replace '^[Vv]\.?', '' -replace '^\.', ''
          $buildDate = Get-Date -Format "yyyy-MM-dd"
          echo "Setting app version to: $version"
          $q = '"'
          $content = @(
            '"""',
            'Version information for Lumina - File Search Assistant.',
            '"""',
            '',
            "VERSION = $q$version$q",
            "BUILD_DATE = $q$buildDate$q",
            "APP_NAME = ${q}Lumina$q",
            '',
            '# GitHub repository info (for reference)',
            "GITHUB_OWNER = ${q}Itsme23476$q",
            "GITHUB_REPO = ${q}App-interface$q",
            '',
            '# Update checking is now done via Supabase (app_version table)',
            '# This allows updates to work even with private GitHub repos'
          )
          $content | Out-File -FilePath "ai_file_organizer/app/version.py" -Encoding utf8
          echo "Updated version.py:"
          Get-Content "ai_file_organizer/app/version.py"
        shell: pwsh
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r ai_file_organizer/requirements.txt
          python -c "import PySide6; print(f'PySide6 version: {PySide6.__version__}')"
          python -c "from PySide6.QtWidgets import QApplication; print('QtWidgets OK')"
          python -c "from PySide6.QtCore import QCoreApplication; print('QtCore OK')"
      
      - name: Build with PyInstaller
        run: |
          cd ai_file_organizer
          $baseArgs = @(
            "--name", "Lumina",
            "--windowed",
            "--onefile",
            "--collect-all", "PySide6",
            "--collect-all", "shiboken6",
            "--collect-all", "spellchecker",
            "--collect-data", "spellchecker",
            "--collect-data", "certifi",
            "--add-data", "app/ui/styles.qss;app/ui",
            "--add-data", "app/ui/styles_light.qss;app/ui",
            "--add-data", "resources;resources",
            "--hidden-import", "PySide6.QtCore",
            "--hidden-import", "PySide6.QtGui",
            "--hidden-import", "PySide6.QtWidgets",
            "--hidden-import", "PySide6.QtNetwork",
            "--hidden-import", "PySide6.QtSvg",
            "--hidden-import", "PySide6.QtSvgWidgets",
            "--hidden-import", "PIL",
            "--hidden-import", "PIL.Image",
            "--hidden-import", "requests",
            "--hidden-import", "certifi",
            "--hidden-import", "openai",
            "--hidden-import", "json5",
            "--hidden-import", "spellchecker",
            "--noconfirm"
          )
          if (Test-Path "resources/iconnn.ico") {
            echo "Building with icon..."
            $baseArgs += @("--icon", "resources/iconnn.ico")
          }
          $baseArgs += "main.py"
          pyinstaller @baseArgs
          $exePath = "dist\Lumina.exe"
          if (Test-Path $exePath) {
            $size = (Get-Item $exePath).Length / 1MB
            echo "EXE size: $([math]::Round($size, 2)) MB"
          }
          dir dist
        shell: pwsh
      
      - name: Verify build output
        run: |
          if (Test-Path "ai_file_organizer/dist/Lumina.exe") {
            echo "Build successful!"
          } else {
            echo "ERROR: EXE not found!"
            exit 1
          }
        shell: pwsh
      
      - name: Create Inno Setup installer script
        run: |
          $version = "${{ github.ref_name }}"
          if ([string]::IsNullOrEmpty($version) -or $version -eq "refs/heads/main") { $version = "1.0.0" }
          # Remove V/v prefix and any leading dots (handles v1.0.0, V.1.0.0, 1.0.0)
          $version = $version -replace '^[Vv]\.?', '' -replace '^\.', ''
          $iconLine = ""
          if (Test-Path "ai_file_organizer/resources/iconnn.ico") {
            $iconLine = "SetupIconFile=ai_file_organizer\resources\iconnn.ico"
          }
          @"
          [Setup]
          AppName=Lumina
          AppVersion=$version
          AppPublisher=Lumina
          DefaultDirName={autopf}\Lumina
          DefaultGroupName=Lumina
          OutputDir=installer
          OutputBaseFilename=Lumina-Setup-v$version
          Compression=lzma
          SolidCompression=yes
          PrivilegesRequired=admin
          UninstallDisplayIcon={app}\Lumina.exe
          CloseApplications=force
          CloseApplicationsFilter=Lumina.exe
          RestartApplications=yes
          $iconLine
          
          [Files]
          Source: "ai_file_organizer\dist\Lumina.exe"; DestDir: "{app}"; DestName: "Lumina.exe"; Flags: ignoreversion
          
          [Icons]
          Name: "{group}\Lumina"; Filename: "{app}\Lumina.exe"
          Name: "{commondesktop}\Lumina"; Filename: "{app}\Lumina.exe"
          
          [Run]
          Filename: "{app}\Lumina.exe"; Description: "Launch Lumina"; Flags: nowait postinstall runasoriginaluser
          "@ | Out-File -FilePath installer.iss -Encoding utf8
        shell: pwsh
      
      - name: Install Inno Setup
        run: choco install innosetup -y
        shell: cmd
      
      - name: Build Installer
        run: |
          mkdir installer
          "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
        shell: cmd
      
      - name: Upload installer as artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: installer/*.exe
          if-no-files-found: error
      
      - name: Upload standalone exe as artifact
        uses: actions/upload-artifact@v4
        with:
          name: standalone-exe
          path: ai_file_organizer/dist/*.exe
          if-no-files-found: error
      
      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            installer/*.exe
            ai_file_organizer/dist/*.exe
          fail_on_unmatched_files: true
      
      - name: Update Supabase app_version table
        if: github.event_name == 'release'
        env:
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          # Remove V/v prefix and any leading dots (handles v1.0.0, V.1.0.0, 1.0.0)
          $version = "${{ github.ref_name }}" -replace '^[Vv]\.?', '' -replace '^\.', ''
          $releaseName = "${{ github.event.release.name }}"
          if ([string]::IsNullOrEmpty($releaseName)) { $releaseName = "Lumina v$version" }
          $releaseNotes = "${{ github.event.release.body }}" -replace '"', '\"' -replace "`r`n", ' ' -replace "`n", ' '
          
          # GitHub release URL (works when repo is public)
          $downloadUrl = "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/Lumina-Setup-v$version.exe"
          
          echo "Version: $version"
          echo "Download URL: $downloadUrl"
          
          if ([string]::IsNullOrEmpty($env:SUPABASE_SERVICE_KEY)) {
            echo "::warning::SUPABASE_SERVICE_KEY not set. Add it to repository secrets."
            exit 0
          }
          
          # Update app_version table with GitHub release URL
          $body = "{`"version`":`"$version`",`"download_url`":`"$downloadUrl`",`"release_name`":`"$releaseName`",`"release_notes`":`"$releaseNotes`",`"is_required`":false}"
          
          try {
            Invoke-RestMethod -Uri "https://gsvccxhdgcshiwgjvgfi.supabase.co/rest/v1/app_version" -Method Post -Headers @{
              "apikey" = $env:SUPABASE_SERVICE_KEY
              "Authorization" = "Bearer $env:SUPABASE_SERVICE_KEY"
              "Content-Type" = "application/json"
              "Prefer" = "return=minimal"
            } -Body $body
            echo "Successfully updated Supabase app_version"
          } catch {
            echo "::warning::Failed to update Supabase: $($_.Exception.Message)"
          }
        shell: pwsh
