name: Build and Release Installer

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build with PyInstaller
        run: |
          python -c "
          import subprocess
          import sys
          
          cmd = [
              sys.executable, '-m', 'PyInstaller',
              '--name', 'AI File Organizer',
              '--onedir',
              '--windowed',
              '--noconfirm',
              '--add-data', 'resources;resources',
              '--add-data', 'app/ui/styles.qss;app/ui',
              '--add-data', 'app/ui/styles_light.qss;app/ui',
              '--hidden-import', 'PySide6.QtCore',
              '--hidden-import', 'PySide6.QtWidgets',
              '--hidden-import', 'PySide6.QtGui',
              '--hidden-import', 'PIL',
              '--hidden-import', 'cv2',
              '--hidden-import', 'moviepy',
              '--hidden-import', 'mutagen',
              '--hidden-import', 'openai',
              '--hidden-import', 'requests',
              '--hidden-import', 'sqlite3',
              '--hidden-import', 'json5',
              '--hidden-import', 'pdf2image',
              '--hidden-import', 'pytesseract',
              '--hidden-import', 'supabase',
              '--exclude-module', 'matplotlib',
              '--exclude-module', 'notebook',
              '--exclude-module', 'jupyter',
              '--exclude-module', 'IPython',
              '--exclude-module', 'tkinter',
              'main.py'
          ]
          subprocess.run(cmd, check=True)
          "
      
      - name: Install Inno Setup
        run: |
          choco install innosetup -y
      
      - name: Update version in installer script
        run: |
          $version = "${{ github.event.release.tag_name }}".TrimStart('v')
          (Get-Content installer.iss) -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"$version`"" | Set-Content installer.iss
      
      - name: Build installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
      
      - name: Upload installer to release
        uses: softprops/action-gh-release@v1
        with:
          files: Output/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update version.json
        run: |
          $version = "${{ github.event.release.tag_name }}".TrimStart('v')
          $releaseNotes = "${{ github.event.release.body }}" -replace '"', '\"'
          $downloadUrl = "https://github.com/${{ github.repository }}/releases/latest"
          
          $json = @{
            version = $version
            download_url = $downloadUrl
            release_notes = $releaseNotes
          } | ConvertTo-Json
          
          $json | Out-File -FilePath version.json -Encoding utf8
      
      - name: Commit version.json
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add version.json
          git commit -m "Update version.json to ${{ github.event.release.tag_name }}" || echo "No changes to commit"
          git push origin HEAD:main || echo "Could not push"
